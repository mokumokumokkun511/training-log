<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Training Log</title>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  background: #f2f2f7;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
}

.app {
  max-width: 480px;
  margin: auto;
  padding: 12px;
}

h1 {
  text-align: center;
  margin-bottom: 12px;
}

.card {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
}

h2 {
  font-size: 1.1em;
  margin-bottom: 8px;
}

input, select, textarea, button {
  width: 100%;
  padding: 10px;
  margin-bottom: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
  box-sizing: border-box;
}

button {
  background: #007aff;
  color: #fff;
  border: none;
}

button.danger { background: #ff3b30; }
button.safe { background: #34c759; }

textarea { height: 80px; }

.small {
  font-size: 0.85em;
  color: #666;
}

canvas {
  width: 100% !important;
  height: 320px !important;
}
</style>
</head>

<body>
<div class="app">
  <h1>ğŸ‹ï¸ Training Log</h1>

  <div class="card">
    <h2>å…¥åŠ›</h2>
    <input id="date" type="date" />
    <input id="weight" type="number" placeholder="é‡é‡ (kg)" />
    <input id="reps" type="number" placeholder="å›æ•°" />
    <input id="sets" type="number" placeholder="ã‚»ãƒƒãƒˆ" />
    <input id="max" type="number" placeholder="MAXæ¸¬å®š (kg)" />
    <button id="saveBtn">ä¿å­˜</button>
  </div>

  <div class="card">
    <h2>æ—¥ä»˜æŒ‡å®šã§å‰Šé™¤</h2>
    <select id="deleteDate"></select>
    <button class="danger" id="deleteBtn">å‰Šé™¤</button>
  </div>

  <div class="card">
    <h2>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
    <p class="small">
      é€šå¸¸ä¿å­˜ï¼šlocalStorage.training_data<br>
      ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šlocalStorage.training_backup
    </p>
    <button class="safe" id="restoreBtn">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button>
  </div>

  <div class="card">
    <h2>ğŸ“… é€±ã‚µãƒãƒªãƒ¼</h2>
    <div id="weekly"></div>
  </div>

  <div class="card">
    <h2>ğŸ—“ æœˆã‚µãƒãƒªãƒ¼</h2>
    <div id="monthly"></div>
  </div>

  <div class="card">
    <h2>ğŸ“ˆ æˆé•·æŒ‡æ•°</h2>
    <div id="growth"></div>
  </div>

  <div class="card">
    <canvas id="chart"></canvas>
  </div>

  <div class="card">
    <button id="exportBtn">Excelç”¨CSVã‚’ã‚³ãƒ”ãƒ¼</button>
    <textarea id="importArea" placeholder="Excelã®CSVã‚’ã“ã“ã«è²¼ã‚‹"></textarea>
    <button id="importBtn">CSVã‚’èª­ã¿è¾¼ã‚€</button>
  </div>
</div>

<script>
const DATA_KEY = "training_data";
const BACKUP_KEY = "training_backup";

let data = JSON.parse(localStorage.getItem(DATA_KEY)) || [];
let chart;

// Elements
const dateEl = document.getElementById("date");
const weightEl = document.getElementById("weight");
const repsEl = document.getElementById("reps");
const setsEl = document.getElementById("sets");
const maxEl = document.getElementById("max");

// Enterã‚­ãƒ¼ç§»å‹•
[weightEl, repsEl, setsEl, maxEl].forEach((el, i, arr) => {
  el.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      arr[i + 1] ? arr[i + 1].focus() : saveData();
    }
  });
});

document.getElementById("saveBtn").onclick = saveData;
document.getElementById("deleteBtn").onclick = deleteByDate;
document.getElementById("restoreBtn").onclick = restoreBackup;
document.getElementById("exportBtn").onclick = exportCSV;
document.getElementById("importBtn").onclick = importCSV;

// ä¿å­˜
function saveData() {
  const date = dateEl.value || new Date().toISOString().slice(0,10);
  const w = +weightEl.value;
  const r = +repsEl.value;
  const s = +setsEl.value;
  const m = +maxEl.value;
  if (!w || !r || !s || !m) return;

  const volume = w * r * s;
  data.push({ date, w, r, s, m, volume });

  localStorage.setItem(DATA_KEY, JSON.stringify(data));
  localStorage.setItem(BACKUP_KEY, JSON.stringify(data));

  clearInputs();
  refresh();
}

function clearInputs() {
  weightEl.value = repsEl.value = setsEl.value = maxEl.value = "";
  weightEl.focus();
}

// å‰Šé™¤
function deleteByDate() {
  const d = document.getElementById("deleteDate").value;
  data = data.filter(x => x.date !== d);
  localStorage.setItem(DATA_KEY, JSON.stringify(data));
  refresh();
}

// å¾©å…ƒ
function restoreBackup() {
  const backup = JSON.parse(localStorage.getItem(BACKUP_KEY));
  if (!backup) return alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—");
  data = backup;
  localStorage.setItem(DATA_KEY, JSON.stringify(data));
  refresh();
}

// CSVå‡ºåŠ›
function exportCSV() {
  let csv = "date,weight,reps,sets,max,volume\n";
  data.forEach(d => {
    csv += `${d.date},${d.w},${d.r},${d.s},${d.m},${d.volume}\n`;
  });
  navigator.clipboard.writeText(csv);
  alert("CSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

// CSVå…¥åŠ›
function importCSV() {
  const text = document.getElementById("importArea").value.trim();
  if (!text) return;
  const lines = text.split("\n").slice(1);
  data = lines.map(l => {
    const [date,w,r,s,m,v] = l.split(",");
    return { date, w:+w, r:+r, s:+s, m:+m, volume:+v };
  });
  localStorage.setItem(DATA_KEY, JSON.stringify(data));
  refresh();
}

// ç·šå½¢å›å¸°
function trend(values) {
  const n = values.length;
  if (n < 2) return [];
  let sx=0, sy=0, sxy=0, sx2=0;
  values.forEach((y,x)=>{
    sx+=x; sy+=y; sxy+=x*y; sx2+=x*x;
  });
  const a = (n*sxy - sx*sy)/(n*sx2 - sx*sx);
  const b = (sy - a*sx)/n;
  return values.map((_,x)=>a*x+b);
}

function refresh() {
  updateDeleteList();
  updateSummary();
  drawChart();
}

function updateDeleteList() {
  const sel = document.getElementById("deleteDate");
  sel.innerHTML = "";
  [...new Set(data.map(d=>d.date))].forEach(d=>{
    const o=document.createElement("option");
    o.value=o.textContent=d;
    sel.appendChild(o);
  });
}

function updateSummary() {
  const last7 = data.slice(-7);
  const avg = arr => arr.reduce((a,b)=>a+b,0)/(arr.length||1);

  document.getElementById("weekly").textContent =
    `å¹³å‡é‡é‡ ${avg(last7.map(d=>d.w)).toFixed(1)}kg / åˆè¨ˆãƒœãƒªãƒ¥ãƒ¼ãƒ  ${last7.reduce((a,b)=>a+b.volume,0)}`;

  document.getElementById("monthly").textContent =
    `MAXæœ€é«˜ ${Math.max(...data.map(d=>d.m),0)}kg`;

  if (data.length>=14) {
    const first = avg(data.slice(0,7).map(d=>d.volume));
    const last = avg(data.slice(-7).map(d=>d.volume));
    document.getElementById("growth").textContent =
      `æˆé•·æŒ‡æ•° ${(last/first).toFixed(2)}`;
  }
}

function drawChart() {
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
      labels: data.map(d=>d.date),
      datasets: [
        { label:"é‡é‡", data:data.map(d=>d.w), borderColor:"blue" },
        { label:"é‡é‡ãƒˆãƒ¬ãƒ³ãƒ‰", data:trend(data.map(d=>d.w)), borderDash:[5,5], pointRadius:0, borderColor:"blue" },
        { label:"ãƒœãƒªãƒ¥ãƒ¼ãƒ ", data:data.map(d=>d.volume), borderColor:"green" },
        { label:"ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒˆãƒ¬ãƒ³ãƒ‰", data:trend(data.map(d=>d.volume)), borderDash:[5,5], pointRadius:0, borderColor:"green" },
        { label:"MAX", data:data.map(d=>d.m), borderColor:"red" },
        { label:"MAXãƒˆãƒ¬ãƒ³ãƒ‰", data:trend(data.map(d=>d.m)), borderDash:[5,5], pointRadius:0, borderColor:"red" }
      ]
    }
  });
}

refresh();
</script>
</body>
</html>
