<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Training Log</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #f2f2f7;
    margin: 0;
    padding: 16px;
  }

  h1 {
    text-align: center;
  }

  .card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  label {
    display: block;
    font-size: 14px;
    margin-top: 8px;
  }

  input, select, textarea, button {
    width: 100%;
    padding: 10px;
    margin-top: 4px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
    box-sizing: border-box;
  }

  button {
    border: none;
    color: white;
    font-weight: bold;
    margin-top: 12px;
  }

  .save { background: #007aff; }
  .delete { background: #ff3b30; }
  .restore { background: #34c759; }

  canvas {
    max-width: 100%;
  }

  small {
    color: #666;
    font-size: 12px;
  }
</style>
</head>

<body>

<h1>ğŸ‹ï¸ Training Log</h1>

<div class="card">
  <h3>å…¥åŠ›</h3>

  <label>æ—¥ä»˜</label>
  <input type="date" id="date" />

  <label>é‡é‡ (kg)</label>
  <input type="number" id="weight" />

  <label>å›æ•°</label>
  <input type="number" id="reps" />

  <label>ã‚»ãƒƒãƒˆ</label>
  <input type="number" id="sets" />

  <label>MAXæ¸¬å®š (kg)</label>
  <input type="number" id="max" />

  <button class="save" onclick="saveData()">ä¿å­˜</button>
</div>

<div class="card">
  <h3>æ—¥ä»˜æŒ‡å®šã§å‰Šé™¤</h3>
  <select id="deleteDate"></select>
  <button class="delete" onclick="deleteByDate()">å‰Šé™¤</button>
</div>

<div class="card">
  <h3>è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h3>
  <small>
    é€šå¸¸ä¿å­˜ï¼šlocalStorage.training_data<br>
    ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šlocalStorage.training_backup
  </small>
  <button class="restore" onclick="restoreBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ</button>
</div>

<div class="card">
  <h3>ğŸ“… é€±ã‚µãƒãƒªãƒ¼</h3>
  <div id="weekly"></div>
</div>

<div class="card">
  <h3>ğŸ“† æœˆã‚µãƒãƒªãƒ¼</h3>
  <div id="monthly"></div>
</div>

<div class="card">
  <h3>ğŸ“ˆ æˆé•·æŒ‡æ•°</h3>
  <div id="growth"></div>
</div>

<div class="card">
  <canvas id="chart"></canvas>
</div>

<div class="card">
  <button class="save" onclick="copyCSV()">Excelç”¨CSVã‚’ã‚³ãƒ”ãƒ¼</button>
  <textarea id="csvInput" placeholder="Excelã®CSVã‚’ã“ã“ã«è²¼ã‚‹"></textarea>
  <button class="save" onclick="importCSV()">CSVã‚’èª­ã¿è¾¼ã‚€</button>
</div>

<script>
let data = JSON.parse(localStorage.getItem("training_data") || "[]");
let backup = JSON.parse(localStorage.getItem("training_backup") || "null");

function saveData() {
  const entry = {
    date: date.value,
    weight: +weight.value,
    reps: +reps.value,
    sets: +sets.value,
    max: +max.value
  };

  if (!entry.date) return alert("æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  backup = JSON.parse(JSON.stringify(data));
  localStorage.setItem("training_backup", JSON.stringify(backup));

  data.push(entry);
  localStorage.setItem("training_data", JSON.stringify(data));

  renderAll();
}

function deleteByDate() {
  const d = deleteDate.value;
  data = data.filter(e => e.date !== d);
  localStorage.setItem("training_data", JSON.stringify(data));
  renderAll();
}

function restoreBackup() {
  if (!backup) return alert("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“");
  data = backup;
  localStorage.setItem("training_data", JSON.stringify(data));
  renderAll();
}

function renderAll() {
  updateDeleteList();
  renderSummary();
  renderChart();
}

function updateDeleteList() {
  deleteDate.innerHTML = "";
  [...new Set(data.map(e => e.date))].forEach(d => {
    const o = document.createElement("option");
    o.value = d;
    o.textContent = d;
    deleteDate.appendChild(o);
  });
}

function renderSummary() {
  if (data.length === 0) return;

  const totalVolume = data.reduce((s,e)=>s+e.weight*e.reps*e.sets,0);
  const avgWeight = (data.reduce((s,e)=>s+e.weight,0)/data.length).toFixed(1);
  weekly.innerText = `å¹³å‡é‡é‡ ${avgWeight}kg / åˆè¨ˆãƒœãƒªãƒ¥ãƒ¼ãƒ  ${totalVolume}`;

  const maxMax = Math.max(...data.map(e=>e.max));
  monthly.innerText = `MAXæœ€é«˜ ${maxMax}kg`;

  growth.innerText = `æˆé•·æŒ‡æ•° ${(maxMax / data[0].max).toFixed(2)}`;
}

function trend(values) {
  const n = values.length;
  let sx=0, sy=0, sxy=0, sx2=0;
  values.forEach((y,x)=>{
    sx+=x; sy+=y; sxy+=x*y; sx2+=x*x;
  });
  const a=(n*sxy-sx*sy)/(n*sx2-sx*sx);
  const b=(sy-a*sx)/n;
  return values.map((_,x)=>a*x+b);
}

let chart;
function renderChart() {
  const labels = data.map(e=>e.date);
  const weightData = data.map(e=>e.weight);
  const volumeData = data.map(e=>e.weight*e.reps*e.sets);
  const maxData = data.map(e=>e.max);

  chart?.destroy();
  chart = new Chart(chartCanvas, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label:"é‡é‡", data: weightData, borderColor:"blue" },
        { label:"é‡é‡ãƒˆãƒ¬ãƒ³ãƒ‰", data: trend(weightData), borderDash:[5,5], borderColor:"blue" },
        { label:"ãƒœãƒªãƒ¥ãƒ¼ãƒ ", data: volumeData, borderColor:"green" },
        { label:"ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒˆãƒ¬ãƒ³ãƒ‰", data: trend(volumeData), borderDash:[5,5], borderColor:"green" },
        { label:"MAX", data: maxData, borderColor:"red" },
        { label:"MAXãƒˆãƒ¬ãƒ³ãƒ‰", data: trend(maxData), borderDash:[5,5], borderColor:"red" }
      ]
    }
  });
}

function copyCSV() {
  const csv = "date,weight,reps,sets,max\n" +
    data.map(e=>`${e.date},${e.weight},${e.reps},${e.sets},${e.max}`).join("\n");
  navigator.clipboard.writeText(csv);
  alert("CSVã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

function importCSV() {
  const rows = csvInput.value.trim().split("\n").slice(1);
  data = rows.map(r=>{
    const [date,weight,reps,sets,max] = r.split(",");
    return {date,weight:+weight,reps:+reps,sets:+sets,max:+max};
  });
  localStorage.setItem("training_data", JSON.stringify(data));
  renderAll();
}

renderAll();
</script>

</body>
</html>
